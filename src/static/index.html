<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<!--    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">-->
    <title>GY</title>
    <!--<link rel="stylesheet" href="css/bootstrap.min.4.3.1.css" type="text/css">-->
    <link rel="stylesheet" href="static/css/lib/iview.4.0.0.css" type="text/css">
    <script src="static/js/lib/jquery-3.4.1.js"></script>
    <script src="static/js/lib/vue.js"></script>
    <script src="static/js/lib/httpVueLoader.js"></script>
    <script src="static/js/lib/iview.min.4.0.0.js"></script>
    <script src='static/js/lib/moment.min.js' async></script>
    <script src="js/components.js"></script>
    <style>
        html,body,#app,.flex-row{
            width: 100%;
        }
        .flex-row{
            width: 60%;
            margin: 2vh auto;
        }
        form{
            width: 100%;
            border: 1px solid #eeeeee;
            overflow: hidden;
        }
        form .form-group{
            float: left;
            display: flex;
            flex-direction: row;
            width: 94%;
            margin-top: 2vh;
            margin-left: 3%;
        }
        form .form-small-group{
            width: 47%;
        }

        form .form-group label{
            width: 12%;
        }
        form .form-small-group label{
            width: 24%;
        }
        form .form-group input{
            width: 70%;
            border: 1px solid #000;
        }
        .flex-row>input{
            width: 40%;
            margin: 2vh 30%;
        }
        form .form-group textarea{
            width: 84.5%;
        }
    </style>
</head>
<body>
<div id="app" class="container-fluid">
    <upload></upload>
    <!--Gy welcome index-->
    <!--<div>{{msg}}</div>-->

    <!--<i-button type="primary" @click="addComponent"/>-->
    <div class="flex-row">
        <!--<i-select />-->
        <input type="text" list="search" v-model="keyword">
        <datalist id="search">
            <template v-for="item in list">
                <option :value="item.id">{{item.label}}</option>
            </template>
        </datalist>
    </div>

    <div class="flex-row">
        <form >
            <div class="form-group form-small-group">
                <label>标签1</label>
                <input v-model="addForm.tag1"/>
            </div>
            <div class="form-group form-small-group">
                <label>标签2</label>
                <input v-model="addForm.tag2"/>
            </div>
            <div class="form-group">
                <label>html代码</label>
                <textarea v-model="addForm.htmlCode" rows="15"></textarea>
            </div>
            <div class="form-group">
                <label>groovy代码</label>
                <textarea v-model="addForm.groovyCode" rows="15"></textarea>
            </div>
            <div class="form-group">
                <input type="button" @click="addComponent" value="添加"/>
            </div>
        </form>
    </div>

    <!--<div>-->
        <!--<form id="form1">-->
            <!--<input type="file" name="file">-->
            <!--<input type="button" value="提交" @click="addFile">-->
        <!--</form>-->
        <!--{{addResult}}-->
    <!--</div>-->
</div>
<script>
    let app = new Vue({
        el: '#app',
        data: {
            ws: null, msg: '', addResult: null,
            optId:'', loading: false, list: [], keyword: '',
            showAddForm: false, addForm: {},
            files: [],
            picUrl: 'http://125.67.237.26:9672/staticResource/freeTrade/recognizeRecord/20200320220709ocrc7ff8db843054ca0/3/2020031010006.jpg'
        },
        components: {
            // upload: httpVueLoader('coms/Upload.vue')()
        },
        mounted: function () {
            // this.initWs();
            this.search('')
        },
        watch: {
            keyword: function (v) {this.search(v)},
            files: function (v) {
                console.log('xxxxxxxxxxxxxxxxxxx: ', v)
            }
        },
        methods: {
            addComponent: function() {
                let _this = this
                $.ajax({
                    url:'addComponent',
                    type: 'post',
                    data: _this.addForm,
                    success: function (resp) {
                        if (resp.code == '00') {
                            app.$Notice.success({title: '成功提示', desc: '添加成功'})
                        } else {
                            app.$Notice.error({title: '失败提示', desc: resp.desc, duration: 7})
                        }
                    }
                })
            },
            search: function(keyword) {
                let _this = this
                // 选择某个选项时
                if (keyword != '' && keyword == _this.optId) {

                }
                _this.loading = true
                $.ajax({
                    url: 'search?keyword=' + keyword,
                    success: function (resp) {
                        _this.loading = false
                        if (resp.code == '00') {
                            _this.list = resp.data
                        } else {
                            _this.list = []
                            app.$Notice.error({title: '错误提示', desc: resp.desc, duration: 7})
                        }
                    }
                })
            },
            addFile: function () {
                let _this = this;
                let fd = new FormData($('#form1')[0])
                $.ajax({
                    url: 'upload',
                    type: 'post',
                    data: fd,
                    contentType: false,
                    processData: false,
                    success: function (resp) {
                        if (resp.code == '00') _this.addResult = resp
                        else app.$Notice.error({title: '错误提示', desc: resp.desc, duration: 7})
                    }
                })
            },
            downXlsx: function() {
                let xhr = new XMLHttpRequest();
                xhr.open('post', 'test/downXlsx', true);
                xhr.responseType = 'blob';
                xhr.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
                xhr.onload = function () {
                    if (this.status == 200) {
                        let blob = this.response;
                        let a = document.createElement('a');
                        let url = window.URL.createObjectURL(blob);
                        a.href = url;
                        //设置文件名称
                        a.download = '用户信息.xls';
                        a.click();
                    }
                }
                xhr.send(JSON.stringify({
                    "type" : 1,
                    "startDate" : "2018-01-01",
                    "endDate" : "2018-12-31"
                }));
            }
        },
    });


    // web socket
    let ws = null;
    function createWs() {
        if (ws && (ws.readyState == 1 || ws.readyState == 2)) {
            console.log('Websocket连接可用不用重创建. state: ' + ws.readyState);
            return;
        }
        console.log('create websocket ...');
        try {
            let protocol = "ws://";
            if (window.location.protocol.startsWith("https")) protocol = "wss://";
            ws = new WebSocket(protocol + window.location.host + "/test/ws");
        } catch (e) {
            console.log('创建websocket错误');
            setTimeout(function () {
                createWs()
            }, (1000 * 60 * 2)); // 每两分钟重试
            return
        }
        ws.onclose = function () {
            setTimeout(function () {
                createWs()
            }, (1000 * 60 * 1)); // 每两分钟重试
        };
        ws.onmessage = function (e) {
            let jo = toJSON(e.data);
            if (jo) {
                // 消息类型
            } else {
                app.$Notice.info({title: '后台提示', desc: e.data, duration: 7})
            }
        };
        ws.onopen = function() {
            console.log('websocket onopen');
            ws.send('成功连接...')
        };
    }
    createWs();

    function toJSON(str) {
        if (typeof str == 'string') {
            try {
                let obj = JSON.parse(str);
                return obj
            } catch(e) {}
        }
        return null
    }
</script>
</body>
</html>