<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rule DSL Engine</title>
    <link rel="stylesheet" href="css/lib/heyui.css" />
    <script src="js/lib/vue.js"></script>
    <script src="js/lib/heyui.js"></script>
    <script src="js/lib/jquery.min.js"></script>
    <script src="js/lib/httpVueLoader.js"></script>
    <script src="js/common.js"></script>
</head>
<body>
<div id="app">
    <Admin v-if="user"></Admin>
    <Login v-else></Login>
</div>
</body>
<script>
    // HeyUI.config({});
    let app = new Vue({
        el: '#app',
        data: {
            // 当前登录用户信息
            user: null
        },
        mounted: function () {
            this.getCurrentUser();
            ws({path: '/mnt/ws'})
        },
        watch: {
            user: (v) => {
                if (v == null) {
                    location.reload()
                }
            }
        },
        methods: {
            getCurrentUser() {
                $.ajax({
                    url: 'mnt/getCurrentUser',
                    async: false,
                    success: (res) => {
                        if (res.code == '00') {
                            this.user = res.data;
                            if (this.user.permissions == undefined || this.user.permissions == null) this.user.permissions = []
                        } else this.$Notice.error(res.desc)
                    }
                })
            }
        }
    });

    // 设置全局自动关闭时间为5秒
    // app.$Notice.config({timeout: 5000});

    $.ajaxSetup({
        complete: (xhr) => {
            if (xhr.status == 401) { // 登录实效 or 未登录
                app.$data.user = null
            } else if (xhr.status == 403) {
                app.$Notice.error('没有权限');
            }
        }
    });
</script>
</html>