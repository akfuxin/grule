<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=10, user-scalable=yes">
    <meta charset="UTF-8">
    <title>Rule Engine</title>
    <link rel="stylesheet" href="../css/lib/iview.4.3.2.css">
    <script src="../js/lib/vue.js"></script>
    <script src="../js/lib/iview.min.4.3.2.js"></script>
<!--    <link rel="stylesheet" href="../ext6.2/classic/theme-neptune/resources/theme-neptune-all.css" type="text/css">-->
<!--&lt;!&ndash;    <script src="../ext6.2/ext-all.js"></script>&ndash;&gt;-->
<!--    <script src="../ext6.2/ext-all-debug.js"></script>-->
<!--    <script src="../ext6.2/classic/theme-neptune/theme-neptune.js"></script>-->
<!--    <script src="../ext6.2/classic/locale/locale-zh_CN.js"></script>-->
<!--    <script src="../js/app.js"></script>-->
</head>
<body>
<div id="app">

</div>
</body>
<script>
    let app = new Vue({
        el: '#app',
        data: {

        },
        methods: {

        }
    });

    // web socket
    function ws(cfg) {
        // web socket
        let ws = null;
        if (ws && (ws.readyState == 1 || ws.readyState == 2)) {
            console.log('Websocket连接可用不用重创建. state: ' + ws.readyState);
            return;
        }
        function doCreate() {
            console.log('create websocket ...');
            try {
                let protocol = "ws://";
                if (window.location.protocol.startsWith("https")) protocol = "wss://";
                ws = new WebSocket(protocol + window.location.host + (cfg.path || "/test/msg"));
            } catch (e) {
                console.log('创建websocket错误', e);
                setTimeout(function () {
                    ws(cfg)
                }, cfg.reconnection || (1000 * 60 * 2)); // 每两分钟重试
                return
            }
            ws.onclose = cfg.onClose || function () {
                setTimeout(function () {
                    ws(cfg)
                }, cfg.reconnection || (1000 * 60 * 2)); // 每两分钟重试
            };
            ws.onmessage = cfg.onMsg || function (e) { //接收websocket 消息
                let jo = toJSON(e.data);
                if (jo) {
                    // {type: 'xxx': data: null}
                    // if (jo.type == 'xxx') {}
                    if (jo.data.msg) {
                        app.$Notice.info({title: '后台提示', desc: jo.data.msg, duration: 5})
                    }
                } else {
                    app.$Notice.info({title: '后台提示', desc: e.data, duration: 7})
                }
            };
            ws.onopen = cfg.onOpen || function() {
                console.log('websocket onopen');
                ws.send('成功连接...')
            };
        }
        doCreate()
    }

    function toJSON(str) {
        if (typeof str == 'string') {
            try {
                let obj = JSON.parse(str);
                return obj
            } catch(e) {}
        }
        return null
    }
</script>
</html>